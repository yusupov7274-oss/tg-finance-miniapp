<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç Supabase</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1e1e1e;
      color: #fff;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #2d2d2d;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      background: #2481cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1e6ba8;
    }
    .success {
      color: #4caf50;
    }
    .error {
      color: #f44336;
    }
    pre {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h1>

  <div class="test-section">
    <h2>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è</h2>
    <div id="env-check"></div>
    <button onclick="checkEnv()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  </div>

  <div class="test-section">
    <h2>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp</h2>
    <div id="telegram-check"></div>
    <button onclick="checkTelegram()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  </div>

  <div class="test-section">
    <h2>3. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (GET)</h2>
    <div id="load-result"></div>
    <button onclick="testLoad()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
  </div>

  <div class="test-section">
    <h2>4. –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (POST)</h2>
    <div id="save-result"></div>
    <button onclick="testSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
  </div>

  <div class="test-section">
    <h2>5. –õ–æ–≥–∏</h2>
    <pre id="logs"></pre>
    <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://zhchkxukgltknfbropqu.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_m96BQEXNJw5_L_CI0kQkUg_0vdPodFS';

    function log(message, type = 'info') {
      const logsEl = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#fff';
      logsEl.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
      logsEl.scrollTop = logsEl.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    window.checkEnv = function() {
      const el = document.getElementById('env-check');
      el.innerHTML = '';
      
      const url = SUPABASE_URL;
      const key = SUPABASE_ANON_KEY;
      
      if (url && key) {
        el.innerHTML = `
          <div class="success">‚úÖ URL: ${url}</div>
          <div class="success">‚úÖ Key: ${key.substring(0, 20)}...</div>
        `;
        log('‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã', 'success');
      } else {
        el.innerHTML = '<div class="error">‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
        log('‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã', 'error');
      }
    };

    window.checkTelegram = function() {
      const el = document.getElementById('telegram-check');
      el.innerHTML = '';
      
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        const initData = tg.initData;
        
        if (initData) {
          el.innerHTML = `
            <div class="success">‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω</div>
            <div class="success">‚úÖ InitData: ${initData.substring(0, 50)}...</div>
            <div>User: ${tg.initDataUnsafe?.user?.first_name || 'N/A'}</div>
            <div>User ID: ${tg.initDataUnsafe?.user?.id || 'N/A'}</div>
          `;
          log('‚úÖ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
        } else {
          el.innerHTML = '<div class="error">‚ùå InitData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
          log('‚ùå InitData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
        }
      } else {
        el.innerHTML = '<div class="error">‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram Mini App)</div>';
        log('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
      }
    };

    window.testLoad = async function() {
      const el = document.getElementById('load-result');
      el.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
      
      if (!window.Telegram?.WebApp?.initData) {
        el.innerHTML = '<div class="error">‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
        return;
      }

      try {
        const initData = window.Telegram.WebApp.initData;
        log('–û—Ç–ø—Ä–∞–≤–∫–∞ GET –∑–∞–ø—Ä–æ—Å–∞...', 'info');
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/sync`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'x-telegram-init-data': initData,
          },
        });

        const data = await response.json();
        
        if (response.ok) {
          el.innerHTML = `
            <div class="success">‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
        } else {
          el.innerHTML = `
            <div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error || response.status}</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          log(`‚ùå –û—à–∏–±–∫–∞: ${data.error || response.status}`, 'error');
        }
      } catch (error) {
        el.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    };

    window.testSave = async function() {
      const el = document.getElementById('save-result');
      el.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      
      if (!window.Telegram?.WebApp?.initData) {
        el.innerHTML = '<div class="error">‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
        return;
      }

      try {
        const initData = window.Telegram.WebApp.initData;
        const testData = {
          accounts: [{ id: 1, name: '–¢–µ—Å—Ç–æ–≤—ã–π —Å—á–µ—Ç', currency: 'RUB', balance: 1000, color: '#2481cc' }],
          transactions: [],
          currencies: [{ code: 'RUB', name: '–†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å', rate: 1, source: 'manual' }],
          expense_plan: 5000,
          closed_months: [],
          balance_checks: [],
          expense_categories: ['–ü—Ä–æ–¥—É–∫—Ç—ã', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç'],
          income_categories: ['–ó–∞—Ä–ø–ª–∞—Ç–∞']
        };
        
        log('–û—Ç–ø—Ä–∞–≤–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞...', 'info');
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/sync`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'x-telegram-init-data': initData,
          },
          body: JSON.stringify(testData),
        });

        const data = await response.json();
        
        if (response.ok) {
          el.innerHTML = `
            <div class="success">‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
        } else {
          el.innerHTML = `
            <div class="error">‚ùå –û—à–∏–±–∫–∞: ${data.error || response.status}</div>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          `;
          log(`‚ùå –û—à–∏–±–∫–∞: ${data.error || response.status}`, 'error');
        }
      } catch (error) {
        el.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
      checkEnv();
      checkTelegram();
    }, 500);
  </script>
</body>
</html>
